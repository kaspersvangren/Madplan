<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>Madplan</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg-page:#faf6f2;
      --bg-panel:#fffaf5;
      --ink:#3a2d25;
      --c-border:#e6dfd7;
      --c-muted:#8b6f61;
      --focus:#d97706;
      --c-include:#2e7d5b;
      --c-exclude:#b84a4a;
    }
    *{ box-sizing:border-box; }
    body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans"; background:var(--bg-page); margin:0; color:var(--ink); }
    h1{ text-align:center; font-weight:700; letter-spacing:.2px; }
    .container{ max-width:1200px; margin:auto; padding:1rem; }
    .layout{ display:flex; gap:2rem; align-items:flex-start; }

    /* Sidebar med fast bredde (så den ikke maser tabellen) */
    .sidebar{
      display:flex; flex-direction:column; gap:1rem;
      position:sticky; top:1rem; align-self:flex-start;
      flex:0 0 380px; width:380px; max-width:420px; z-index:10;
    }
    .panel{ background:var(--bg-panel); border:1px solid var(--c-border); border-radius:12px; padding:.75rem 1rem; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .panel h3{ margin:.25rem 0 .5rem; }

    /* Samlet uge-boks */
    .ugeboks .top{ display:flex; align-items:center; justify-content:space-between; gap:.5rem; margin-bottom:.5rem; }
    .nav{ display:flex; align-items:center; gap:.4rem; }
    .nav button{ border-radius:8px; padding:.3rem .55rem; border:1px solid var(--c-border); background:#fff; cursor:pointer; }
    .nav button:disabled{ opacity:.4; cursor:not-allowed; }
    .range{ font-weight:700; color:#5b463a; }
    .muted{ color:var(--c-muted); font-size:.9rem; }

    .drop-row{
      border:1px dashed #d8cfc6; border-radius:10px; padding:.5rem .6rem; margin:.45rem 0; min-height:2.2rem; background:#fff;
      display:flex; align-items:center; gap:.6rem;
      overflow:hidden; /* v2.7: hold indhold (input/X) inde i boksen */
    }
    .drop-row.dragover{ background-color:#f1fbf6; border-color:#7ed9ac; }
    .drop-row .label{ min-width:120px; text-align:right; font-weight:600; color:#5b463a; }
    .ret-chip{
      flex:1; display:flex; align-items:center; justify-content:space-between; gap:.5rem;
      min-width:0; /* v2.7: tillad shrink af navnet */
    }
    .ret-chip .name{
      flex:1; font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      min-width:0; /* v2.7 */
    }
    .clear{
      width:22px; height:22px; border-radius:999px; border:1px solid #c9bdb2; background:#fffaf5; cursor:pointer;
      flex-shrink:0; /* v2.7: X må ikke presses ud */
    }

    .spist-input{
      flex:1 1 0%; padding:.45rem .6rem; border:1px solid #e0d7cf; border-radius:8px; font-size:.95rem;
      min-width:0; /* v2.7: må gerne krympe i flex */
    }

    .actions{ display:flex; align-items:center; justify-content:flex-end; gap:.6rem; margin-top:.6rem; }
    .btn{ appearance:none; border:1px solid var(--c-border); background:#4a372a; color:#fff; border-radius:10px; padding:.55rem .9rem; font-weight:700; cursor:pointer; box-shadow:0 1px 2px rgba(0,0,0,.06); }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }

    /* Filtre */
    fieldset{ border:1px solid var(--c-border); padding:1rem; border-radius:12px; background:var(--bg-panel); box-shadow:0 1px 2px rgba(0,0,0,.04); }
    fieldset legend{ padding:0 .3rem; font-weight:600; color:var(--ink); }
    .tri-grid{ display:grid; grid-template-columns: 1fr repeat(3,56px); gap:.25rem .6rem; align-items:center; }
    .tri-grid .head{ font-size:.9rem; text-align:center; color:#5b463a; font-weight:700; user-select:none; }
    .tri-grid .head.ex{ color:#b84a4a; }
    .tri-grid .head.in{ color:#2e7d5b; }
    .tri-grid .row-label{ font-size:.95rem; color:var(--ink); font-weight:600; padding:.25rem 0; }
    .radio-input{ position:absolute; opacity:0; width:0; height:0; }
    .radio-ui{ --size:18px; width:var(--size); height:var(--size); border-radius:999px; border:2px solid #c9bdb2; background:#fff; display:inline-block; cursor:pointer; position:relative; }
    .radio-input:focus-visible + .radio-ui{ outline:2px solid var(--focus); outline-offset:2px; }
    .radio-input:checked + .radio-ui{ border-color:var(--ink); }
    .radio-input:checked + .radio-ui::after{ content:""; position:absolute; top:50%; left:50%; width:8px; height:8px; transform:translate(-50%,-50%); background:var(--ink); border-radius:999px; }

    .switch{ display:flex; align-items:center; gap:.6rem; }
    .switch input{ display:none; }
    .switch .slider{ position:relative; width:46px; height:26px; background:#eadfd6; border-radius:999px; box-shadow: inset 0 1px 2px rgba(0,0,0,.08); transition:background .2s; }
    .switch .slider::after{ content:""; position:absolute; top:3px; left:3px; width:20px; height:20px; border-radius:999px; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.15); transition:left .2s; }
    .switch input:checked + .slider{ background:#bfe6cd; }
    .switch input:checked + .slider::after{ left:23px; }
    .switch .switch-label{ font-weight:600; color:var(--ink); }

    /* Retter-listen – lad den fylde resten, og undgå at min-content tvinger vandret scroll */
    .table-wrap{
      border:1px solid var(--c-border); border-radius:12px; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.04);
      max-height:calc(100vh - 160px); overflow:auto;
      flex:1 1 auto; min-width:0;
    }
    table{ width:100%; border-collapse:separate; border-spacing:0; background:white; }
    th,td{ padding:.6rem .7rem; border-bottom:1px solid #efe7df; white-space:nowrap; font-size:.95rem; color:var(--ink); }
    thead th{ position:sticky; top:0; z-index:5; background:#fffaf5; font-weight:700; border-bottom:1px solid var(--c-border); box-shadow:0 1px 0 rgba(0,0,0,0.03); }
    .navn-cell{ max-width:350px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:600; }

    /* Gør indkøbslisten smal-venlig */
    #indkoebsliste-result{
      white-space:pre-wrap;           /* behold linjeskift */
      overflow-wrap:anywhere;         /* må bryde næsten hvor som helst */
      word-break:break-word;          /* fallback */
      line-height:1.35;
      font-size:0.95rem;
    }

    /* v2.8 — Mobil: vis KUN ugeboksen (read-only) */
    @media (max-width: 800px){
      .layout{ display:block; }
      /* skjul alt undtagen ugeboks-panel i sidebaren */
      .layout > *:not(.sidebar){ display:none !important; }
      .sidebar > *:not(.ugeboks){ display:none !important; }
      /* skjul handlinger (knapper/status) i ugeboks */
      .ugeboks .actions{ display:none !important; }
    }

    /* Print kun indkøbsliste pænt */
    @media print{
      body{ background:white; }
      .layout > *:not(.sidebar){ display:none !important; }
      .sidebar > *:not(#print-panel){ display:none !important; }
      #print-panel{ border:none; box-shadow:none; }
      #indkoebsliste-result{ white-space:pre-wrap; font-size:12pt; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Madplan <small style="font-size:.6em; color:#8b6f61;">version 2.8</small></h1>
    <div class="layout">
      <div class="sidebar">
        <!-- Samlet boks: Plan (kommende) / Tilbageblik (1–3 uger) -->
        <div class="panel ugeboks">
          <div class="top">
            <div class="nav">
              <button id="view-prev" title="Én uge længere tilbage">‹</button>
              <span class="range" id="view-range">–</span>
              <button id="view-next" title="Én uge frem">›</button>
            </div>
            <div class="muted" id="view-hint"></div>
          </div>
          <div id="week-rows"></div>
          <div class="actions">
            <span id="primary-status" class="muted"></span>
            <button id="primary-btn" class="btn">Indkøbsliste</button>
          </div>
        </div>

        <!-- Filtre -->
        <fieldset>
          <legend>Praktisk (vælg pr. felt)</legend>
          <div class="tri-grid" role="group" aria-label="Tri-state praktisk">
            <div></div>
            <div class="head ex">✕</div>
            <div class="head in">✔</div>
            <div class="head ig">–</div>

            <div class="row-label" id="rowlabel-agnes">Agnes kan lide</div>
            <div class="cell"><input class="radio-input" type="radio" name="agnes-mode" id="agnes-exclude" value="exclude"><label class="radio-ui" for="agnes-exclude"></label></div>
            <div class="cell"><input class="radio-input" type="radio" name="agnes-mode" id="agnes-include" value="include"><label class="radio-ui" for="agnes-include"></label></div>
            <div class="cell"><input class="radio-input" type="radio" name="agnes-mode" id="agnes-ignore" value="ignore" checked><label class="radio-ui" for="agnes-ignore"></label></div>

            <div class="row-label" id="rowlabel-to-dage">Kan spises 2 dage</div>
            <div class="cell"><input class="radio-input" type="radio" name="to-dage-mode" id="to-dage-exclude" value="exclude"><label class="radio-ui" for="to-dage-exclude"></label></div>
            <div class="cell"><input class="radio-input" type="radio" name="to-dage-mode" id="to-dage-include" value="include"><label class="radio-ui" for="to-dage-include"></label></div>
            <div class="cell"><input class="radio-input" type="radio" name="to-dage-mode" id="to-dage-ignore" value="ignore" checked><label class="radio-ui" for="to-dage-ignore"></label></div>

            <div class="row-label" id="rowlabel-nem">Nem ret</div>
            <div class="cell"><input class="radio-input" type="radio" name="nem-mode" id="nem-exclude" value="exclude"><label class="radio-ui" for="nem-exclude"></label></div>
            <div class="cell"><input class="radio-input" type="radio" name="nem-mode" id="nem-include" value="include"><label class="radio-ui" for="nem-include"></label></div>
            <div class="cell"><input class="radio-input" type="radio" name="nem-mode" id="nem-ignore" value="ignore" checked><label class="radio-ui" for="nem-ignore"></label></div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Vegetar</legend>
          <label id="label-vegetar" class="switch">
            <input type="checkbox" id="filter-vegetar-only">
            <span class="slider"></span>
            <span class="switch-label">Vis kun vegetar</span>
          </label>
        </fieldset>

        <!-- Indkøbsliste + kopi/print -->
        <div class="panel" id="print-panel">
          <div style="display:flex; gap:.5rem; align-items:center; justify-content:space-between; margin-bottom:.5rem;">
            <strong>Indkøbsliste</strong>
            <span>
              <button id="copy-btn" class="btn" style="padding:.35rem .6rem;">Kopiér</button>
              <button id="print-btn" class="btn" style="padding:.35rem .6rem;">Print</button>
            </span>
          </div>
          <div id="indkoebsliste-result"></div>
        </div>
      </div>

      <!-- Retter-listen -->
      <div class="table-wrap">
        <table id="madplan">
          <thead>
            <tr id="thead-row">
              <th>Navn</th>
              <th>Vegetar</th>
              <th>2 dage</th>
              <th>Nem ret</th>
              <th>Agnes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    /* =========
       Konstanter
       ========= */
    const WEBAPP_URL    = "https://script.google.com/macros/s/AKfycbyrbuiVQ0-vDenrKPLC6y1WHzy8BDLo-jK0mLyQTqwuPYRyE41_cZ6ieKwEM4GaqRYbkA/exec";
    const WEBAPP_SECRET = "Freddy";
    const SHEET_ID      = "1P9R6NsSxydpwJ3eOeYyrKBTrXnlAZd5mR1XQdVW7Lx4";
    const HISTORIK_CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Historik`;
    const MADPLAN_CSV_URL  = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Madplan`;

    /* =========
       Dato-format (DK)
       ========= */
    const WD_SHORT = ["søn","man","tir","ons","tor","fre","lør"];
    const WD_PLAN  = ["fredag","lørdag","søndag","mandag","tirsdag","onsdag","torsdag"]; // planrækkefølge
    function isoLocal(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${day}`; }
    function ddmm(d){ const dt = (d instanceof Date)? d : new Date(d); return String(dt.getDate()).padStart(2,"0")+"."+String(dt.getMonth()+1).padStart(2,"0"); }
    function labelDdMm(ds, idx){ const wd = WD_PLAN[idx]; return wd.charAt(0).toUpperCase()+wd.slice(1) + " (" + ddmm(ds) + ")"; }
    function rangeLabel(d1, d7){ const a = new Date(d1), b = new Date(d7); const w1=WD_PLAN[0].slice(0,3), w7=WD_PLAN[6].slice(0,3); return `${w1} ${ddmm(a)} → ${w7} ${ddmm(b)}`; }

    function nextFridayDate(base=new Date()){
      const dow = base.getDay(); let delta = (5 - dow + 7) % 7; if (delta === 0) delta = 7;
      const d = new Date(base.getFullYear(), base.getMonth(), base.getDate() + delta); d.setHours(0,0,0,0); return d;
    }
    function nextWeekDatesFriThu(){
      const start = nextFridayDate(new Date()); const arr=[]; for (let i=0;i<7;i++){ const d=new Date(start.getFullYear(), start.getMonth(), start.getDate()+i); arr.push(isoLocal(d)); } return arr;
    }
    function backWeekDates(i){ const nf = nextFridayDate(new Date()); const start = new Date(nf.getFullYear(), nf.getMonth(), nf.getDate() - i*7); const arr=[]; for (let d=0; d<7; d++){ const dt=new Date(start.getFullYear(), start.getMonth(), start.getDate()+d); arr.push(isoLocal(dt)); } return arr; }

    /* =========
       v2.8 Mobil-heuristik & hjælpefunktion
       ========= */
    const MOBILE_VIEWER = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || matchMedia("(max-width: 800px)").matches || (new URLSearchParams(location.search).get("viewer")==="1");

    function hasPlansNextWeek(){
      const dates = nextWeekDatesFriThu();
      for (const ds of dates){
        const rec = historikMap.get(ds);
        if (rec && (rec.plan_nu||"").toString().trim().length>0){ return true; }
      }
      return false;
    }

    /* =========
       WebApp POST (no-cors)
       ========= */
    async function postToWebApp(payload){
      try{ await fetch(WEBAPP_URL, { method:"POST", body: JSON.stringify(payload), mode:"no-cors", cache:"no-store" }); }
      catch(err){ console.warn("WebApp POST fejl:", err); }
    }

    /* =========
       Historik-CSV
       ========= */
    let historikMap = new Map(); // dato -> { ugedag, plan_nu, spist }
    let lastEatenByName = new Map(); // lower(name) -> seneste ISO-dato

    async function loadHistorik(){
      const text = await fetch(HISTORIK_CSV_URL, { cache:"no-store" }).then(r => r.text());
      const parsed = Papa.parse(text, { header:true });
      historikMap = new Map();
      (parsed.data || []).forEach(row => {
        const dato = (row["dato"] || "").trim(); if (!dato) return;
        historikMap.set(dato, {
          ugedag: (row["ugedag"]||"").trim(),
          plan_nu: (row["plan_nu"]||"").toString(),
          spist:   (row["spist"]||"").toString()
        });
      });
      recomputeLastEaten();
    }

    function recomputeLastEaten(){
      lastEatenByName = new Map();
      const setIfNewer = (name, date) => {
        const key=(name||"").trim().toLowerCase(); if(!key) return;
        const cur=lastEatenByName.get(key); if(!cur || date>cur) lastEatenByName.set(key,date);
      };
      // Vælg spist hvis udfyldt, ellers plan_nu
      historikMap.forEach((rec, ds) => {
        const consumed = (rec.spist||"").trim();
        const planned  = (rec.plan_nu||"").trim();
        const name = consumed || planned;
        if (name) setIfNewer(name, ds);
      });
      // opdater tooltips i tabellen
      document.querySelectorAll("#madplan tbody tr").forEach(tr => {
        const name = tr.getAttribute("data-name")||"";
        const dt = lastEatenByName.get(name.toLowerCase());
        tr.title = dt ? `Sidst spist: ${dt}` : "Sidst spist: –";
      });
    }

    /* =========
       Ugepanel (viewIdx=0 plan; 1..3 tilbage)
       ========= */
    let viewIdx = 0;
    function weekRowsEl(){ return document.getElementById("week-rows"); }
    function rangeEl(){ return document.getElementById("view-range"); }
    function hintEl(){ return document.getElementById("view-hint"); }
    function btnEl(){ return document.getElementById("primary-btn"); }
    function statusEl(){ return document.getElementById("primary-status"); }

    function renderWeekPanel(){
      const rows = weekRowsEl(); rows.innerHTML = "";
      const dates = (viewIdx===0) ? nextWeekDatesFriThu() : backWeekDates(viewIdx);
      rangeEl().textContent = rangeLabel(dates[0], dates[6]);

      // v2.8: Navigationstilstand afhænger af desktop vs mobil
      if (MOBILE_VIEWER){
        // Tilbage op til 3; frem kun hvis (viewIdx>1) eller (viewIdx===1 og næste uge har plan)
        const canPrev = viewIdx < 3;
        const canNext = (viewIdx > 1) || (viewIdx === 1 && hasPlansNextWeek());
        document.getElementById("view-prev").disabled = !canPrev;
        document.getElementById("view-next").disabled = !canNext;

        // READ-ONLY visning: vis spist hvis findes, ellers plan — ingen inputs/clear/draggable
        hintEl().textContent = "Visning (mobil)";
        dates.forEach((ds, i) => {
          const row = document.createElement("div"); row.className="drop-row"; row.dataset.date=ds; row.dataset.type="readonly";
          const label = document.createElement("div"); label.className="label"; label.textContent = labelDdMm(ds, i);
          const chip  = document.createElement("div"); chip.className="ret-chip";
          const rec = historikMap.get(ds) || {};
          const name = (rec.spist || rec.plan_nu || "").toString().trim();
          chip.innerHTML = `<span class="name">${name || "—"}</span>`;
          row.appendChild(label); row.appendChild(chip);
          rows.appendChild(row);
        });
        return; // vigtigt: desktop-rendering nedenfor springes over
      }

      // Desktop (uændret adfærd fra 2.7)
      document.getElementById("view-prev").disabled = (viewIdx >= 3);
      document.getElementById("view-next").disabled = (viewIdx <= 0);

      if (viewIdx === 0){
        hintEl().textContent = "Planlæg næste uge · Træk retter ind";
        btnEl().textContent = "Indkøbsliste";
        btnEl().disabled = false;

        dates.forEach((ds, i) => {
          const row = document.createElement("div"); row.className="drop-row"; row.dataset.date=ds; row.dataset.type="plan";
          const label = document.createElement("div"); label.className="label"; label.textContent = labelDdMm(ds, i);
          const chip  = document.createElement("div"); chip.className="ret-chip"; chip.innerHTML = `<span class="name"></span>`;
          const clear = document.createElement("button"); clear.className="clear"; clear.textContent="×"; clear.addEventListener("click", () => setPlanValue(row,""));
          row.appendChild(label); row.appendChild(chip); row.appendChild(clear);
          setupDnDRow(row);
          rows.appendChild(row);

          const h = historikMap.get(ds); const v = h && (h.plan_nu||"").trim();
          if (v) setPlanValue(row, v);
        });

      } else {
        hintEl().textContent = "Tilbageblik · Ret hvad der blev spist";
        btnEl().textContent = "Gem ændringer";
        btnEl().disabled = false;

        dates.forEach((ds, i) => {
          const row = document.createElement("div"); row.className="drop-row"; row.dataset.date=ds; row.dataset.type="spist";
          const label = document.createElement("div"); label.className="label"; label.textContent = labelDdMm(ds, i);
          const input = document.createElement("input"); input.type="text"; input.className="spist-input"; input.placeholder="Ret-navn";
          const clear = document.createElement("button"); clear.className="clear"; clear.textContent="×"; clear.addEventListener("click", () => { input.value=""; updateSpistLocal(ds, ""); });
          row.appendChild(label); row.appendChild(input); row.appendChild(clear);
          setupDnDRow(row, input);
          rows.appendChild(row);

          const h = historikMap.get(ds);
          const vSpist = h && (h.spist||"").trim();
          const vPlan  = h && (h.plan_nu||"").trim();
          input.value = vSpist || vPlan || "";
        });
      }
    }

    // Global reference for flytning mellem rækker
    let dragSource = null;

    function setupDnDRow(rowEl, inputEl){
      // Tillad drop (fra tabel eller andre rækker)
      rowEl.addEventListener("dragover", e => { e.preventDefault(); rowEl.classList.add("dragover"); });
      rowEl.addEventListener("dragleave", () => rowEl.classList.remove("dragover"));
      rowEl.addEventListener("drop", e => {
        e.preventDefault(); rowEl.classList.remove("dragover");
        const navn = e.dataTransfer.getData("application/x-ret-navn") || "";
        if (!navn) return;

        if (rowEl.dataset.type === "plan"){
          setPlanValue(rowEl, navn);
        } else {
          if (inputEl) inputEl.value = navn;
          updateSpistLocal(rowEl.dataset.date, navn);
        }
        // Flyt (ryd kilde), hvis kilden er en anden uge-række
        if (dragSource && dragSource !== rowEl){
          const srcType = dragSource.dataset.type;
          if (srcType === "plan"){
            setPlanValue(dragSource, "");
          } else {
            const inp = dragSource.querySelector(".spist-input");
            if (inp){ inp.value = ""; updateSpistLocal(dragSource.dataset.date, ""); }
          }
        }
        dragSource = null;
      });

      // Gør rækken selv "draggable" (flyt mellem dagene)
      rowEl.setAttribute("draggable","true");
      rowEl.addEventListener("dragstart", ev => {
        dragSource = rowEl;
        const val = (rowEl.dataset.type === "plan")
          ? (rowEl.querySelector(".ret-chip .name").textContent || "")
          : (rowEl.querySelector(".spist-input")?.value || "");
        ev.dataTransfer.setData("application/x-ret-navn", val);
      });
    }

    function setPlanValue(rowEl, navn){
      const chipName = rowEl.querySelector(".ret-chip .name");
      chipName.textContent = navn || "";
      rowEl.dataset.ret = navn || "";
      const ds = rowEl.dataset.date;
      const rec = historikMap.get(ds) || { ugedag:"", plan_nu:"", spist:"" };
      rec.plan_nu = navn || "";
      historikMap.set(ds, rec);
      recomputeLastEaten();
    }

    function updateSpistLocal(ds, navn){
      const rec = historikMap.get(ds) || { ugedag:"", plan_nu:"", spist:"" };
      rec.spist = navn || "";
      historikMap.set(ds, rec);
      recomputeLastEaten();
    }

    async function doPrimaryAction(){
      statusEl().textContent = "";
      if (viewIdx === 0){
        // Indkøbsliste + snapshot_plan
        buildLists();
        const dates = nextWeekDatesFriThu();
        const items = Array.from(document.querySelectorAll("#week-rows .drop-row")).map((row,i) => ({
          date: dates[i], ret: (row.dataset.ret || "").trim()
        }));
        statusEl().textContent = `— Sender planen til arket (${rangeLabel(dates[0], dates[6])}) …`;
        await postToWebApp({ secret: WEBAPP_SECRET, action:"snapshot_plan", items });
        statusEl().textContent = `✓ Plan sendt (${rangeLabel(dates[0], dates[6])})`;
      } else {
        // save_spist for den viste uge
        const dates = backWeekDates(viewIdx);
        const items = dates.map((ds, i) => {
          const inp = document.querySelectorAll("#week-rows .spist-input")[i];
          return { date: ds, ret: (inp?.value||"").trim() };
        });
        statusEl().textContent = "Gemmer…";
        await postToWebApp({ secret: WEBAPP_SECRET, action:"save_spist", items });
        items.forEach(it => updateSpistLocal(it.date, it.ret)); // optimistisk
        statusEl().textContent = "✓ Gemt";
      }
    }

    /* =========
       Retter fra Madplan-fanen
       ========= */
    const COLS = {
      navn: ["Navn"],
      vegetar: ["Vegetar"],
      toDage: ["2 dage","To dage","2dage"],
      nem: ["Nem ret","Nem"],
      agnes: ["Agnes"],
      koeb: ["Køb","Koeb","Indkøb","Indkoeb"],
      tjek: ["Tjek","Tjek om vi har","Tjek liste"],
      overvej: ["Overvej","Tilbehør","Tilbehor"]
    };
    function getCol(row, keys){ for (const k of keys){ if (k in row) return row[k]; } return ""; }
    function hasX(row, keys){ return keys.some(k => (row[k]||"").trim().toUpperCase()==="X"); }

    let allRows = [];
    const tableBody = document.querySelector("#madplan tbody");

    function visFiltreredeRetter(){
      tableBody.innerHTML = "";
      allRows.forEach(row => {
        if (!passesPractical(row)) return;
        if (!passesVegetarian(row)) return;

        const name = (getCol(row, COLS.navn) || "").trim();
        const tr = document.createElement("tr"); tr.setAttribute("data-name", name.toLowerCase());
        const last = lastEatenByName.get(name.toLowerCase());
        tr.title = last ? `Sidst spist: ${last}` : "Sidst spist: –";

        const navnTd = document.createElement("td");
        const navnDiv = document.createElement("div"); navnDiv.className="navn-cell"; navnDiv.textContent = name;
        navnTd.appendChild(navnDiv); tr.appendChild(navnTd);

        const displayCols = [
          { cols: COLS.vegetar }, { cols: COLS.toDage }, { cols: COLS.nem }, { cols: COLS.agnes }
        ];
        displayCols.forEach(dc => {
          const td = document.createElement("td"); td.textContent = hasX(row, dc.cols) ? "✔" : ""; tr.appendChild(td);
        });

        // drag source (kopierer navn ind i rækker ved drop)
        tr.setAttribute("draggable","true");
        tr.addEventListener("dragstart", e => { e.dataTransfer.setData("application/x-ret-navn", name); });

        tableBody.appendChild(tr);
      });
      updateFilterLabelStyles();
    }

    function passesPractical(row){
      const rules = [
        { group:"agnes", cols: COLS.agnes },
        { group:"to-dage", cols: COLS.toDage },
        { group:"nem", cols: COLS.nem },
      ];
      for (const r of rules){
        const mode = getMode(r.group);
        if (mode === "include" && !hasX(row, r.cols)) return false;
        if (mode === "exclude" && hasX(row, r.cols)) return false;
      }
      return true;
    }
    function getMode(group){ const el = document.querySelector(`input[name="${group}-mode"]:checked`); return el? el.value : "ignore"; }
    function passesVegetarian(row){ const vegOnly = document.getElementById("filter-vegetar-only")?.checked; return !vegOnly || hasX(row, ["Vegetar"]); }
    function updateFilterLabelStyles(){
      const sets=[["agnes","rowlabel-agnes"],["to-dage","rowlabel-to-dage"],["nem","rowlabel-nem"]];
      sets.forEach(([g,id]) => {
        const m = getMode(g), el = document.getElementById(id);
        if(!el) return; el.style.color = (m==="include")?"#2e7d5b":(m==="exclude"?"#b84a4a":"var(--ink)");
      });
      const vegEl = document.getElementById("filter-vegetar-only"); const vegLabel = document.getElementById("label-vegetar");
      if (vegEl && vegLabel) vegLabel.style.opacity = vegEl.checked ? "1" : "0.8";
    }

    /* =========
       Indkøbsliste (tekst) + kopi/print
       ========= */
    function capFirst(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : s; }

    function buildLists(){
      const dates = nextWeekDatesFriThu();
      const rows = Array.from(document.querySelectorAll("#week-rows .drop-row"));
      const ugeValg = rows.map((row,i) => {
        const navn = (row.dataset.ret || "").trim();
        return navn ? { dag: WD_PLAN[i], navn } : null;
      }).filter(Boolean);

      const brugte = ugeValg.map(v => ({ v, row: allRows.find(r => (getCol(r, COLS.navn)||"").trim()===v.navn) })).filter(x => x.row);

      const ugeLinjer = ugeValg.map(v => capFirst(v.dag) + ": " + v.navn);

      const indkoebSet = new Set(), tjekSet = new Set();
      brugte.forEach(({row}) => {
        const koeb = (getCol(row, COLS.koeb)||"").split(",").map(s=>s.trim()).filter(Boolean);
        const tjek = (getCol(row, COLS.tjek)||"").split(",").map(s=>s.trim()).filter(Boolean);
        koeb.forEach(v=>indkoebSet.add(v)); tjek.forEach(v=>tjekSet.add(v));
      });
      tjekSet.forEach(item => indkoebSet.delete(item));

      const indkoebListe = Array.from(indkoebSet).sort((a,b)=>a.localeCompare(b,"da",{sensitivity:"base"}));
      const tjekListe    = Array.from(tjekSet).sort((a,b)=>a.localeCompare(b,"da",{sensitivity:"base"}));

      // v2.7: ingen sær-kapitalisering af første element — ens formatering
      const formatList = arr => arr.length ? "• " + arr.join("\n• ") : "-";

      const out = [
        "1. Ugens madretter:",
        (ugeLinjer.length ? ugeLinjer.join("\n") : "- (ingen valgt)"),
        "",
        "2. Indkøbsliste:",
        formatList(indkoebListe),
        "",
        "3. Tjek om vi har:",
        formatList(tjekListe)
      ].join("\n");
      document.getElementById("indkoebsliste-result").textContent = out;
    }

    async function copyList(){
      const txt = document.getElementById("indkoebsliste-result").textContent || "";
      try{
        await navigator.clipboard.writeText(txt);
        alert("Indkøbsliste kopieret ✅");
      }catch{
        // fallback
        const ta = document.createElement("textarea"); ta.value = txt; document.body.appendChild(ta); ta.select();
        try{ document.execCommand("copy"); alert("Indkøbsliste kopieret ✅"); }finally{ document.body.removeChild(ta); }
      }
    }
    function printList(){ window.print(); }

    /* =========
       Init
       ========= */
    document.addEventListener("DOMContentLoaded", async () => {
      // Hent historik først (til tooltips + forudfyldning)
      await loadHistorik();

      // v2.8: På mobil starter vi i aktuel uge (viewIdx=1). Desktop starter som før (viewIdx=0).
      viewIdx = MOBILE_VIEWER ? 1 : 0;
      renderWeekPanel();

      // Nav-knapper — desktop som før; mobil med speciel fremad-regel
      document.getElementById("view-prev").addEventListener("click", () => {
        const maxBack = 3;
        if (viewIdx < maxBack){ viewIdx++; renderWeekPanel(); }
      });
      document.getElementById("view-next").addEventListener("click", () => {
        if (!MOBILE_VIEWER){
          if (viewIdx > 0){ viewIdx--; renderWeekPanel(); }
        } else {
          // Mobil: 3->2->1 altid; 1->0 kun hvis næste uge er planlagt
          if (viewIdx > 1){ viewIdx--; renderWeekPanel(); }
          else if (viewIdx === 1 && hasPlansNextWeek()){ viewIdx = 0; renderWeekPanel(); }
        }
      });

      document.getElementById("primary-btn").addEventListener("click", doPrimaryAction);

      // Indkøbsliste kopi/print
      document.getElementById("copy-btn").addEventListener("click", copyList);
      document.getElementById("print-btn").addEventListener("click", printList);
    });

    // Hent retter og byg tabel
    fetch(MADPLAN_CSV_URL).then(r=>r.text()).then(csv=>{
      const result = Papa.parse(csv, { header:true });
      allRows = (result.data||[]).filter(r => ((getCol(r, COLS.navn)||"").trim().length>0));
      allRows.sort((a,b)=>(getCol(a, COLS.navn)||"").localeCompare(getCol(b, COLS.navn)||"","da",{sensitivity:"base"}));
      visFiltreredeRetter();

      // filter events
      document.querySelectorAll('.tri-grid input[type="radio"]').forEach(r => r.addEventListener("change", visFiltreredeRetter));
      document.getElementById("filter-vegetar-only")?.addEventListener("change", visFiltreredeRetter);
    });
  </script>
</body>
</html>
